<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>A simple map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<!--<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
<script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>-->
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
<script type="text/javascript" src="../MovingMarker_withrotation.js"></script>
<script src=http://cdn.pubnub.com/pubnub-3.7.12.min.js></script>
<!--<img src="http://www.wpclipart.com/travel/traffic_lights/traffic_lights_2/.cache/traffic_light_green.png"></a>-->
<style>
body { margin:0;padding:0;}
#map { position:absolute; top:0; bottom:0; width:100%; }

</style>
</head>
<body>
<pre id='coordinates' class='ui-coordinates'></pre>
<div id='map'></div>
<style>
pre.ui-coordinates {
  position:absolute;
  bottom:10px;
  left:10px;
  padding:5px 10px;
  background:rgba(0,0,0,0.5);
  color:#fff;
  font-size:11px;
  line-height:18px;
  border-radius:3px;
  }
</style>
<script>

L.mapbox.accessToken = 'pk.eyJ1IjoiYXJhdmluZGMiLCJhIjoiOTBhNDM0ZWNmYTc3MDYzMjA0MjBmY2E5NGU3YmQ0MDYifQ.5s9Z-KPF9yvgT05nO12HOQ';
var map = L.mapbox.map('map', 'aravindc.mln6j3bd',{
    // the options here prevent mouse wheel or trackpad scrolling
    // and restrict the zooms to zoom levels 14 through 18
    scrollWheelZoom: true,
    maxZoom: 18,
    minZoom: 10
}).setView([37.7813,-122.4198], 16);
//map.featureLayer.on('move',function(e){
//	map.panTo(e.layer.getLatLng)});
var longroute = [[37.784198 ,-122.439605],[37.784774 ,-122.439724],[37.786182 ,-122.440025],[37.786391 ,-122.438391],[37.786597 ,-122.436742],
				 [37.786775 ,-122.435309],[37.786966 ,-122.433866],[37.787148 ,-122.432434],[37.787335 ,-122.431002],[37.787517 ,-122.429559],
				 [37.787701 ,-122.428124],[37.787886 ,-122.426683],[37.78807 ,-122.425243],[37.787216 ,-122.425074],[37.786377 ,-122.424902],
				 [37.78552 ,-122.424731],[37.784681,-122.424559], [37.783706 ,-122.424361],[37.782728 ,-122.424165],[37.781751 ,-122.423964],
				 [37.780776 ,-122.423771],[37.7798 ,-122.423573],[37.778824 ,-122.423376],[37.777847 ,-122.423179],[37.776871,-122.422982],
				 [37.776511 ,-122.422899],[37.776428 , -122.422907],[37.775949 ,-122.422792],[37.776105 ,-122.421586],[37.77626 ,-122.42038],
				 [37.776417 ,-122.419176],[37.776574 , -122.417972],[37.776532 ,-122.417494],[37.775264 ,-122.415896],[37.773903 ,-122.41419],
				 [37.772656 , -122.412623],[37.77141 , -122.411065],[37.770328,-122.409748],[37.769809,-122.409072],[37.769292,-122.408404],
				 [37.768592,-122.407838],[37.767568,-122.407736],[37.766546 , -122.40764],[37.76552 ,-122.407543],[37.764498, -122.407444],
				 [37.763365, -122.407339],[37.763208, -122.407329],[37.763136, -122.407371],[37.760401, -122.407114],[37.756832, -122.406773],
				 [37.756921, -122.40529]];

var vehicle_marker = L.Marker.movingMarker(longroute,[15000,15000,15000,15000,15000,15000,15000,15000,15000,15000
													,15000,15000,15000,15000,15000,15000,15000,15000,15000,15000
													,15000,15000,15000,15000,15000,15000,15000,15000,15000,15000
													,15000,15000,15000,15000,15000,15000,15000,15000,15000,15000
													,15000,15000,15000,15000,15000,15000,15000,15000,15000,15000],
													[260,260,350,350,350,350,350,350,350,350,350,350,80,80,80,80,80,
													80,80,80,80,80,80,80,80,80,80,348,348,348,348,0,50,50,50,50,
													50,50,50,60,85,85,85,85,85,85,85,85,85,350],
	{ 
	icon:L.icon({
	iconUrl:'file:///home/rajeev/Desktop/Leaflet.MovingMarker-master/myamb_svg.svg',
	iconSize: [45,45]})}).addTo(map);
   
var polyline = L.polyline(longroute).addTo(map);

vehicle_marker.once('click', function() {
	vehicle_marker.start();
    vehicle_marker.closePopup();
    vehicle_marker.unbindPopup();
    vehicle_marker.on('click', function() {
          if (vehicle_marker.isRunning()) {
				vehicle_marker.pause();
        } else {
            vehicle_marker.start();
        }
    });
    setTimeout(function() {
  
        vehicle_marker.bindPopup('<b>Click me to pause !</b>').openPopup();
  }, 2000);
});
vehicle_marker.bindPopup('<b>Click me to start !</b>', {closeOnClick: false});
vehicle_marker.openPopup();

vehicle_marker.on('pause',function () {
	console.log("pause fired");
	if (vehicle_marker.isRunning()) 
		{

			vehicle_marker.pause();
		} 
});

vehicle_marker.on('resume',function () {
	console.log("resume fired");
	if (!vehicle_marker.isRunning()) 
		{
			vehicle_marker.resume();
		} 
});

function toRad(x) {
   return x * Math.PI / 180;
}
//Number.prototype.toRad = function() {
// return this * Math.PI / 180;//var lat2 = 42.741; //var lon2 = -71.3161; //var lat1 = 42.806911; //var lon1 = -71.290611; 
function distance(latt,lonn,list1_1,list1_2){
	//console.log("distance funtion");
	var R = 6371; // km 
	//has a problem with the .toRad() method below.
	var lat1 = parseFloat(latt);
	var lat2 = parseFloat(list1_1);
	var lon1 = parseFloat(lonn);
	var lon2 = parseFloat(list1_2);
	var x1 = lat2-lat1;
	var dLat = toRad(x1);  
	var x2 = lon2-lon1;	
	var dLon = toRad(x2);  
	var a = (Math.sin(dLat/2) * Math.sin(dLat/2) + 
             Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
             Math.sin(dLon/2) * Math.sin(dLon/2));  
	var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
	var d = R * c;
	var d = d*1000;
	return d;
//alert(d);
}


var st_lat = 37.784774 ; 
var st_lon = -122.439724;
var sp_lat,sp_lon;

vehicle_marker.on('move',function () {
	var m = vehicle_marker.getLatLng();
	var v_lat = m.lat.toString();
	var v_lon = m.lng.toString();
	sp_lat = v_lat;
	sp_lon = v_lon;
	dist = distance(st_lat,st_lon,sp_lat,sp_lon);
	console.log(st_lat,st_lon,sp_lat,sp_lon)
	if (dist >=10 && dist <= 15)
		{
			//console.log(dist);
			pub(sp_lat,sp_lon);
			st_lat = sp_lat;
			st_lon = sp_lon;
			
		}
	
	control(v_lat,v_lon);
	coordinates.innerHTML = 'Latitude: ' + m.lat + '<br />Longitude: ' + m.lng;});

//var a = parseInt(0);
var di;
var flag = false;

function control(latt,lonn){
	var list = ["37.786188","-122.440033","37.787237","-122.431801","37.785359","-122.424704",
				"37.778739","-122.423349","37.776381","-122.419514","37.772811","-122.412835","37.765782","-122.407557"];
	di =  distance(latt,lonn,list[2*PN],list[(2*PN)+1]);
	//console.log(di)
			
	if (flag == false){
		if(typeof(arrayA[PN]) === 'undefined' && di<160) {
		
			vehicle_marker.fire('pause');
			flag = true;
			
		}
	}
}

var PN = parseInt (0);
var arrayA = [];
function check_san(m2){
	var str = m2[0].toString();
	var nu = parseInt(m2[1]);
	//alert(m2);
	if (nu == 1){
		if (str == "yes")
		{
			PN =parseInt(PN+1);
			arrayA.push(str);
			var Divisadero_st = L.marker([37.786188,-122.440033],{icon:exceptionIcon}).addTo(map);
			if (flag == true){vehicle_marker.fire('resume');}
			
		}
		else
		{
			var Divisadero_st = L.marker([37.786188,-122.440033],{icon:sanfrnsIcon}).addTo(map);
			flag = false;
		}
	}if(nu == 2){
		if(str == "yes")
		{
			PN =parseInt(PN+1);
			arrayA.push(str);
			var Webster_st = L.marker([37.787237,-122.431801],{icon:exceptionIcon}).addTo(map);
			if (flag == true){vehicle_marker.fire('resume');}
		}
		else
		{
			var Webster_st = L.marker([37.787237,-122.431801],{icon:sanfrns1Icon}).addTo(map);
			flag = false;
		}
	}if (nu == 3){
		if (str == "yes")
		{
			PN =parseInt(PN+1);
			arrayA.push(str);
			var Gough_st = L.marker([37.785359,-122.424704],{icon:exceptionIcon}).addTo(map);
			if (flag == true){vehicle_marker.fire('resume');}
		}
		else
		{
			var Gough_st = L.marker([37.785359,-122.424704],{icon:sanfrns1Icon}).addTo(map);
			flag = false;
		}
	}if (nu == 4){
		if (str == "yes")
		{
			PN =parseInt(PN+1);
			arrayA.push(str);
			var Fulton_st = L.marker([37.778739,-122.423349],{icon:exceptionIcon}).addTo(map);
			if (flag == true){vehicle_marker.fire('resume');}
		}
		else
		{
			var Fulton_st = L.marker([37.778739,-122.423349],{icon:sanfrns2Icon}).addTo(map);
			flag = false;
		}
	}if (nu == 5){
		if (str == "yes")
		{
			PN =parseInt(PN+1);
			arrayA.push(str);
			var Fell_St = L.marker([37.776381,-122.419514],{icon:exceptionIcon}).addTo(map);
			if (flag == true){vehicle_marker.fire('resume');}
		}
		else
		{
			var Fell_st = L.marker([37.776381,-122.419514],{icon:sanfrnsIcon}).addTo(map);
			flag = false;
		}
	}if (nu == 6){
		if (str == "yes")
		{
			PN =parseInt(PN+1);
			arrayA.push(str);
			var Folsom_St = L.marker([37.772811,-122.412835],{icon:exceptionIcon}).addTo(map);
			if (flag == true){vehicle_marker.fire('resume');}
		}
		else
		{
			var Folsom_St = L.marker([37.772811,-122.412835],{icon:sanfrns2Icon}).addTo(map);
			flag = false;
		}
	}if (nu == 7){
		if (str == "yes")
		{
			PN =parseInt(PN+1);
			arrayA.push(str);
			var sixteenth_st = L.marker([37.765782,-122.407557],{icon:exceptionIcon}).addTo(map);
			if (flag == true){vehicle_marker.fire('resume');}
		}
		else
		{
			var sixteenth_st = L.marker([37.765782,-122.407557],{icon:sanfrnsIcon}).addTo(map);
			flag = false;
		}
	}
	}
var pubnub = PUBNUB({                          
		publish_key   : 'pub-c-8f807eab-2a85-44fc-bfca-e9ff6e22cdc9',
		subscribe_key : 'sub-c-07dda524-1406-11e5-90f9-02ee2ddab7fe'
			});
function pub(latt,lonn){
	 var lat = latt.substring(0,11);
	var lon = lonn.substring(0,11);
	
	pubnub.publish({                                    
	channel : "test18",
	message : {lat,lon}
	})
	};


function sub_san(){
	
	pubnub.subscribe({
				channel :"san",
				message :function (m2){check_san(m2)},
				error : function(error) {
			//handle error here
				console.log(JSON.stringify(error));}
				
			})
	};
sub_san();
var exceptionIcon = L.icon({
	iconUrl:'file:///home/rajeev/Desktop/Leaflet.MovingMarker-master/Leaflet.MovingMarker-master/examples/Traffic-lights_onlygreen.svg',
	iconSize: [60,50],
	iconAnchor:[22,94],
	popupAnchor:[-3,-76]});

var sanfrnsIcon = L.icon({
	//iconUrl: 'http://www.spriteland.com/sprites/downloads/traffic-lights-sprite.svg',// THE SVG FROM INTERNET
    iconUrl:'file:///home/rajeev/Desktop/Leaflet.MovingMarker-master/Leaflet.MovingMarker-master/examples/Traffic-lights.svg',
	iconSize:     [65, 50], // size of the icon
    iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
    popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var sanfrns1Icon = L.icon({
	//iconUrl: 'http://www.spriteland.com/sprites/downloads/traffic-lights-sprite.svg',// THE SVG FROM INTERNET
    iconUrl:'file:///home/rajeev/Leaflet.MovingMarker-master/Leaflet.MovingMarker-master/examples/ord1.svg',
	iconSize:     [65, 50], // size of the icon
    iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
    popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});
var sanfrns2Icon = L.icon({
	//iconUrl: 'http://www.spriteland.com/sprites/downloads/traffic-lights-sprite.svg',// THE SVG FROM INTERNET
    iconUrl:'file:///home/rajeev/Leaflet.MovingMarker-master/Leaflet.MovingMarker-master/examples/ord2.svg',
	iconSize:     [65, 50], // size of the icon
    iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
    popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});
var Divisadero_st = L.marker([37.786188,-122.440033], {icon: sanfrnsIcon}).addTo(map);
var Webster_st 	  = L.marker([37.787237,-122.431801], {icon: sanfrns1Icon}).addTo(map);

var Gough_st  	  = L.marker([37.785359,-122.424704], {icon: sanfrns1Icon}).addTo(map);
var Fulton_st     = L.marker([37.778739,-122.423349], {icon: sanfrns2Icon}).addTo(map);

var Fell_st   	  = L.marker([37.776381,-122.419514], {icon: sanfrnsIcon}).addTo(map);
var Folsom_St     = L.marker([37.772811,-122.412835], {icon: sanfrns2Icon}).addTo(map);
var sixteenth_st  = L.marker([37.765782,-122.407557], {icon: sanfrnsIcon}).addTo(map);

	</script>

	</body>

</html>


