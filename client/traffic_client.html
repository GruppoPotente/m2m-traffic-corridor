<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Real-Time Traffic Corridor for Emergency Vehicle (SanFrancisco)</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
<script type="text/javascript" src="moving_marker_with_rotation.js"></script>
<script src=http://cdn.pubnub.com/pubnub-3.7.12.min.js></script>

<style>
   body { margin:0;padding:0;}
   #map { position:absolute; top:0; bottom:0; width:100%; }
</style>
</head>
<body>
<pre id='coordinates' class='ui-coordinates'></pre>
<div id='map'></div>
<style>
pre.ui-coordinates {
  position:absolute;
  bottom:10px;
  left:10px;
  padding:5px 10px;
  background:rgba(0,0,0,0.5);
  color:#fff;
  font-size:11px;
  line-height:18px;
  border-radius:3px;
  }
</style>
<script>

/*your mapbox access token and map id*/

L.mapbox.accessToken = 'pk.eyJ1IjoiYXJhdmluZGMiLCJhIjoiOTBhNDM0ZWNmYTc3MDYzMjA0MjBmY2E5NGU3YmQ0MDYifQ.5s9Z-KPF9yvgT05nO12HOQ';
var map = L.mapbox.map('map', 'aravindc.mln6j3bd',{
    // the options here prevent mouse wheel or trackpad scrolling
    // and restrict the zooms to zoom levels 10 through 18
    scrollWheelZoom: true,
    maxZoom: 18,
    minZoom: 10
}).setView([37.7813,-122.4198], 16);

/* Ambulance route data */

var ambulance_route = [ [37.784149,-122.439601],[37.784409 ,-122.439665],[37.784683,-122.439711],
			[37.784774,-122.439724],[37.786182 ,-122.440025],
			[37.786391 ,-122.438391],[37.786597 ,-122.436742],[37.786775 ,-122.435309],
			[37.786966 ,-122.433866],[37.787148 ,-122.432434],[37.787335 ,-122.431002],
			[37.787517 ,-122.429559],[37.787701 ,-122.428124],[37.787886 ,-122.426683],
			[37.78807 ,-122.425243],[37.787216 ,-122.425074],[37.786377 ,-122.424902],
			[37.78552 ,-122.424731],[37.784681,-122.424559], [37.783706 ,-122.424361],
			[37.782728 ,-122.424165],[37.781751 ,-122.423964],[37.780776 ,-122.423771],
			[37.7798 ,-122.423573],[37.778824 ,-122.423376],[37.777847 ,-122.423179],
			[37.776871,-122.422982],[37.776511 ,-122.422899],[37.776428 , -122.422907],
			[37.775949 ,-122.422792],[37.776105 ,-122.421586],[37.77626 ,-122.42038],
			[37.776417 ,-122.419176],[37.776574 , -122.417972],[37.776532 ,-122.417494],
			[37.775264 ,-122.415896],[37.773903 ,-122.41419],[37.772656 , -122.412623],
			[37.77141 , -122.411065],[37.770328,-122.409748],[37.769809,-122.409072],
			[37.769292,-122.408404],[37.768592,-122.407838],[37.767568,-122.407736],
			[37.766546 , -122.40764],[37.76552 ,-122.407543],[37.764498, -122.407444],
			[37.763365, -122.407339],[37.763208, -122.407329],[37.763136, -122.407371],
			[37.760401, -122.407114],[37.756832, -122.406773],[37.756921, -122.40529]  ];

/*Set ambulance route,speed and angle*/ 

var vehicle_marker = L.Marker.movingMarker(ambulance_route,
					[ 1000,1000,1000,10000,10000,10000,10000,10000,10000,10000,10000,10000,10000,
					  10000,10000,10000,10000,10000,10000,10000,10000,10000,10000,
					  10000,10000,10000,10000,10000,10000,10000,10000,10000,10000,
					  10000,10000,10000,10000,10000,10000,10000,10000,10000,10000,
					  10000,10000,10000,10000,10000,10000,10000,10000,10000,10000],
					[ 260,260,260,260,350,350,350,350,350,350,350,350,350,350,80,
					  80,80,80,80,80,80,80,80,80,80,80,80,80,80,348,348,348,348,
					  0,50,50,50,50,50,50,50,60,85,85,85,85,85,85,85,85,85,350],{

					  icon:L.icon({
						iconUrl:'file:///C:/Users/Aravind/Downloads/m2m-traffic-corridor-master/m2m-traffic-corridor-master/client/ambulance_car.svg',
						iconSize: [45,45]})
						}).addTo(map);
   
var polyline = L.polyline(ambulance_route).addTo(map);

/*Traffic signal icons declaration*/

var green_signalIcon = L.icon({
	iconUrl:     'file:///C:/Users/Aravind/Downloads/m2m-traffic-corridor-master/m2m-traffic-corridor-master/client/green_signal.svg',
	iconSize:    [65,50],
	iconAnchor:  [22,94],
	popupAnchor: [-3,-76]
});

var red_signalIcon = L.icon({
	iconUrl:     'file:///C:/Users/Aravind/Downloads/m2m-traffic-corridor-master/m2m-traffic-corridor-master/client/green_signal.svg',
	iconSize:    [65,50],
	iconAnchor:  [22,94],
	popupAnchor: [-3,-76]
});

var ordinaryflow1 = L.icon({
       iconUrl:      'file:///C:/Users/Aravind/Downloads/m2m-traffic-corridor-master/m2m-traffic-corridor-master/client/ordinary_flow1.svg',
       iconSize:     [65, 50], // size of the icon
       iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
       popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var ordinaryflow2 = L.icon({
       iconUrl:      'file:///C:/Users/Aravind/Downloads/m2m-traffic-corridor-master/m2m-traffic-corridor-master/client/ordinary_flow2.svg',
       iconSize:     [65, 50], // size of the icon
       iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
       popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});
var ordinaryflow3 = L.icon({
       iconUrl:	     'file:///C:/Users/Aravind/Downloads/m2m-traffic-corridor-master/m2m-traffic-corridor-master/client/ordinary_flow3.svg',
       iconSize:     [65, 50], // size of the icon
       iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
       popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

/*Signal placement on map*/

var signal_1   = L.marker([37.786188,-122.440033], {icon: ordinaryflow1}).addTo(map);
var signal_2   = L.marker([37.787237,-122.431801], {icon: ordinaryflow2}).addTo(map);
var signal_3   = L.marker([37.785359,-122.424704], {icon: ordinaryflow2}).addTo(map);
var signal_4   = L.marker([37.778739,-122.423349], {icon: ordinaryflow3}).addTo(map);
var signal_5   = L.marker([37.776381,-122.419514], {icon: ordinaryflow1}).addTo(map);
var signal_6   = L.marker([37.772811,-122.412835], {icon: ordinaryflow3}).addTo(map);
var signal_7   = L.marker([37.765782,-122.407557], {icon: ordinaryflow1}).addTo(map);

/*Marker movement controls*/

vehicle_marker.once('click', function() {
    vehicle_marker.start();
    pubnub.publish({channel : "your publishing channel",message : "start"});
    vehicle_marker.closePopup();
    vehicle_marker.unbindPopup();
    vehicle_marker.on('click', function() {
          if (vehicle_marker.isRunning()) {
		vehicle_marker.pause();
        } else {
                vehicle_marker.start();
        }
    });
    setTimeout(function() {
          vehicle_marker.bindPopup('<b>Click me to pause !</b>').openPopup();
  }, 2000);
});
vehicle_marker.bindPopup('<b>Click me to start !</b>', {closeOnClick: false});
vehicle_marker.openPopup();

/*Vehicle marker pause event function*/

vehicle_marker.on('pause',function () {
	console.log("pause fired");
	if (vehicle_marker.isRunning()) 
	{
	   vehicle_marker.pause();
	} 
});

/*Vehicle marker resume event*/

vehicle_marker.on('resume',function () {
	console.log("resume fired");
	if (!vehicle_marker.isRunning()) 
	{
	   vehicle_marker.resume();
	} 
});

/*Distance calculation function*/

function toRad(x) {
   return x * Math.PI / 180;
}
 
function distance(latt,lonn,list1_1,list1_2){
	var R = 6371; // km 
	var lat1 = parseFloat(latt);
	var lat2 = parseFloat(list1_1);
	var lon1 = parseFloat(lonn);
	var lon2 = parseFloat(list1_2);
	var x1 = lat2-lat1;
	var dLat = toRad(x1);  
	var x2 = lon2-lon1;	
	var dLon = toRad(x2);  
	var a = (Math.sin(dLat/2) * Math.sin(dLat/2) + 
             Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
             Math.sin(dLon/2) * Math.sin(dLon/2));  
	var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
	var d = R * c;
	var d = d*1000;
	return d;
}

/* Acquiring vehicle marker's lattitude & longitude and publishing to pubnub*/

var st_lat = 37.784774 ; 
var st_lon = -122.439724;


vehicle_marker.on('move',function () {
	var m = vehicle_marker.getLatLng();
	var v_lat = m.lat.toString();
	var v_lon = m.lng.toString();
	
	dist = distance(st_lat,st_lon,v_lat,v_lon);
	//console.log(st_lat,st_lon,v_lat,v_lon)
	if (dist >= 10 && dist <= 15)
		{
			publishing_func(v_lat,v_lon);
			st_lat = v_lat;
			st_lon = v_lon;
		}
	else{
		st_lat = v_lat;
		st_lon = v_lon;
	}
	stop (v_lat,v_lon);
	control (v_lat,v_lon);
	coordinates.innerHTML = 'Latitude: ' + m.lat + '<br />Longitude: ' + m.lng;});

/*Control function for traffic signal synchronization */

var di;
var flag = false;

function control(latt,lonn){
	var list = [    "37.786188","-122.440033",
			"37.787237","-122.431801",
			"37.785359","-122.424704",
		        "37.778739","-122.423349",
		        "37.776381","-122.419514",
		        "37.772811","-122.412835",
		        "37.765782","-122.407557"];
	di =  distance(latt,lonn,list[2*PN],list[(2*PN)+1]);
	
	if (flag == false){
		if(typeof(arrayA[PN]) === 'undefined' && di<70) {
			vehicle_marker.fire('pause');
			flag = true;
		}
	}
}

var arrayB = [  37.786188,-122.440033,
	        37.787237,-122.431801,
		37.785359,-122.424704,
		37.778739,-122.423349,
		37.776381,-122.419514,
		37.772811,-122.412835,
		37.765782,-122.407557];

var arrayC = [ordinaryflow1,ordinaryflow2,ordinaryflow2,ordinaryflow3,ordinaryflow1,ordinaryflow3,ordinaryflow1];
var PN = parseInt (0);
var arrayA = [];

function check_san(m){
	var str = m[0].toString();
	var nu = parseInt(m[1]);
	
	if(str == "red")
	{
		var signal_1 = L.marker([arrayB[2*PN],arrayB[2*PN+1]],{icon: red_signalIcon}).addTo(map);
	}
	
	if (str == "green")
		{
			var signal_1   = L.marker([arrayB[2*PN],arrayB[2*PN+1]], {icon: green_signalIcon}).addTo(map);
			PN =parseInt(PN+1);
			arrayA.push(str);
			if (flag == true){vehicle_marker.fire('resume');}
		}
	if(str == "withdraw")
		{
			//console.log(arrayC[PN-1])
			//console.log(PN)
			var signal_1  = L.marker([arrayB[(2*PN)-2],arrayB[(2*PN)-1]],{icon:arrayC[PN-1]}).addTo(map);			
			flag = false;
		}
	}

/*Publishing latitude & longitude to server*/

var pubnub = PUBNUB({                          
			publish_key   : 'your publishing key',		//your pubnub keys here
			subscribe_key : 'your subscribing key'
		});
function publishing_func(latt,lonn){
			 var lat = latt.substring(0,11);
	        	 var lon = lonn.substring(0,11);
		pubnub.publish({                                    
			channel : "your publishing channel",		//your channel name here
			message : {lat,lon}
		})
	};

/*Subscribing to the server*/

function subscribing_func(){
	pubnub.subscribe({
			channel :"your subscribing channel",		//your subscribing channel here
			message :function (m){check_san(m)},
			error : function(error) {
			console.log(JSON.stringify(error));}
			})
		};

subscribing_func();

function stop (lat,lon)
{
	 dis = distance(37.756809,-122.406781,lat,lon);
	 if (dis <= 50){
		  pubnub.publish({
		  	channel : "your publishing channel",
		  	message : "stop"});
	 }
}
</script>
</body>
</html>


